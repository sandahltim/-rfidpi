<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RFID Inventory Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .nav-tabs { background: #2c3e50; border-bottom: 3px solid #e74c3c; }
        .nav-link { color: #ecf0f1; font-weight: bold; padding: 12px 20px; transition: all 0.3s ease; }
        .nav-link:hover { color: #e74c3c; background: #34495e; }
        .nav-link.active { color: #fff; background: #e74c3c; border: none; box-shadow: 0 0 10px rgba(231, 76, 60, 0.7); }
        body { background: #ecf0f1; font-family: 'Arial', sans-serif; }
        .container { background: #fff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 20px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <header class="mb-4">
        <nav>
            <ul class="nav nav-tabs">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab1/">Active Rentals</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab2/">Categories</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab3/">Service Items</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab4/">Full Inventory</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab5/">Laundry Contracts</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab6/">Resale Items</a></li>
            </ul>
        </nav>
        <div class="mt-2">
            <form action="/manual_refresh" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-primary">Refresh Data</button>
            </form>
            <form action="/manual_refresh_dev" method="POST" style="display: inline; margin-left: 10px;">
                <button type="submit" class="btn btn-secondary">Refresh Test App</button>
            </form>
        </div>
    </header>
    {% block content %}{% endblock %}
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global data store
let currentTableData = {};

function basePrintAggregate(contract) {
    console.log(`basePrintAggregate called with contract: ${contract}`);
    const middleData = currentTableData.middle_map || {};
    const parentData = currentTableData.parent_data || [];
    const aggregateItems = middleData[contract] || [];
    const parent = parentData.find(p => p.contract_num === contract || p.category === contract) || {};
    console.log(`aggregateItems:`, aggregateItems, `parent:`, parent);

    const aggregateWin = window.open('', '_blank');
    if (!aggregateWin) {
        console.error("basePrintAggregate: Failed to open window—popup blocker?");
        return;
    }

    aggregateWin.document.write([
        '<html>',
        '  <head>',
        `    <title>Active Aggregate: ${contract}</title>`,
        '    <style>',
        '      body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }',
        '      h1 { font-size: 1.5em; text-align: center; color: #2c3e50; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }',
        '      p { font-size: 1em; text-align: center; color: #34495e; margin-bottom: 20px; }',
        '      table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }',
        '      th, td { border: 2px solid #34495e; padding: 8px; text-align: left; }',
        '      th { background: #3498db; color: #fff; font-weight: bold; }',
        '      tr:nth-child(even) { background: #f9f9f9; }',
        '      tr:hover { background: #dfe6e9; }',
        '    </style>',
        '  </head>',
        '  <body>',
        `    <h1>Active Aggregate: ${contract}</h1>`,
        `    <p>Last Scan Date: ${parent.scan_date || parent.date_last_scanned || 'N/A'}</p>`,
        '    <table>',
        '      <thead>',
        '        <tr>',
        '          <th>Common Name</th>',
        '          <th>Total on Contract</th>',
        '        </tr>',
        '      </thead>',
        '      <tbody>'
    ].join('\n'));

    aggregateItems.forEach(item => {
        aggregateWin.document.write([
            '        <tr>',
            `          <td>${item.common_name}</td>`,
            `          <td>${item.total_on_contract || item.total || 0}</td>`,
            '        </tr>'
        ].join('\n'));
    });

    aggregateWin.document.write([
        '      </tbody>',
        '    </table>',
        '  </body>',
        '</html>'
    ].join('\n'));

    aggregateWin.document.close();
    aggregateWin.focus();
    aggregateWin.print();
    aggregateWin.close();
}

function basePrintItems(contract, commonName, subcat = null) {
    console.log(`basePrintItems called with contract: ${contract}, commonName: ${commonName}, subcat: ${subcat}`);
    const contractMap = currentTableData.contract_map || {};
    let itemList = (contractMap[contract] && contractMap[contract][commonName]) || [];

    if (subcat) {
        const urlParams = new URLSearchParams(window.location.search);
        const params = {
            category: contract,
            subcat: subcat,
            common_name: commonName,
            page: 1,
            common_name_filter: urlParams.get('common_name') || '',
            tag_id: urlParams.get('tag_id') || '',
            bin_location: urlParams.get('bin_location') || '',
            last_contract_num: urlParams.get('last_contract_num') || '',
            status: urlParams.get('status') || ''
        };
        const url = `/tab2/subcat_data?${new URLSearchParams(params).toString()}`;
        console.log(`Fetching items from: ${url}`);

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                itemList = data.items || [];
                console.log(`Fetched itemList:`, itemList);
                renderBasePrintItems(contract, commonName, itemList, subcat);
            })
            .catch(error => {
                console.error('Error fetching items:', error);
                alert('Failed to print items: ' + error.message);
            });
    } else {
        renderBasePrintItems(contract, commonName, itemList);
    }
}

function renderBasePrintItems(contract, commonName, itemList, subcat = null) {
    const itemsWin = window.open('', '_blank');
    if (!itemsWin) {
        console.error("basePrintItems: Failed to open window—popup blocker?");
        return;
    }

    const title = subcat ? `Items: ${contract} - ${subcat} - ${commonName}` : `Active Rental Items: ${contract} - ${commonName}`;
    itemsWin.document.write([
        '<html>',
        '  <head>',
        `    <title>${title}</title>`,
        '    <style>',
        '      body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }',
        '      h1 { font-size: 1.5em; text-align: center; color: #2c3e50; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }',
        '      table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }',
        '      th, td { border: 2px solid #34495e; padding: 8px; text-align: left; }',
        '      th { background: #3498db; color: #fff; font-weight: bold; }',
        '      tr:nth-child(even) { background: #f9f9f9; }',
        '      tr:hover { background: #dfe6e9; }',
        '    </style>',
        '  </head>',
        '  <body>',
        `    <h1>${title}</h1>`,
        '    <table>',
        '      <thead>',
        '        <tr>',
        '          <th>Tag ID</th>',
        '          <th>Quality</th>',
        '          <th>Bin Location</th>',
        '          <th>Status</th>',
        '          <th>Last Scanned By</th>',
        '          <th>Date Last Scanned</th>',
        '          <th>Notes</th>',
        '        </tr>',
        '      </thead>',
        '      <tbody>'
    ].join('\n'));

    itemList.forEach(item => {
        itemsWin.document.write([
            '        <tr>',
            `          <td>${item.tag_id || 'N/A'}</td>`,
            `          <td>${item.quality || 'N/A'}</td>`,
            `          <td>${item.bin_location || 'N/A'}</td>`,
            `          <td>${item.status || 'N/A'}</td>`,
            `          <td>${item.last_scanned_by || 'Unknown'}</td>`,
            `          <td>${item.date_last_scanned || 'N/A'}</td>`,
            `          <td>${item.notes || 'N/A'}</td>`,
            '        </tr>'
        ].join('\n'));
    });

    itemsWin.document.write([
        '      </tbody>',
        '    </table>',
        '  </body>',
        '</html>'
    ].join('\n'));

    itemsWin.document.close();
    itemsWin.focus();
    itemsWin.print();
    itemsWin.close();
}

document.addEventListener("DOMContentLoaded", function() {
    console.log("Base DOM Content Loaded");

    function refreshTableData() {
        const currentPath = window.location.pathname;
        const urlParams = new URLSearchParams(window.location.search);
        const refreshUrl = `${currentPath.endsWith('/') ? currentPath : currentPath + '/'}refresh_data?${urlParams.toString()}`;

        fetch(refreshUrl)
            .then(response => {
                console.log(`Refresh Fetch Status: ${response.status}`);
                if (!response.ok) {
                    console.log(`Refresh endpoint not available for ${currentPath}, skipping...`);
                    return null; // Silently skip if endpoint doesn't exist
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log("Refresh Data:", data);
                    currentTableData = data; // Only update if data is received
                }
            })
            .catch(error => console.error("Refresh Error:", error));
    }

    // Event delegation for base print buttons
    document.getElementById("parentTable")?.addEventListener("click", function(event) {
        const target = event.target;
        console.log("Click detected on:", target);
        if (target.classList.contains("print-aggregate-btn")) {
            const contract = target.getAttribute("data-contract");
            basePrintAggregate(contract);
        } else if (target.classList.contains("print-items-btn")) {
            const contract = target.getAttribute("data-contract");
            const commonName = target.getAttribute("data-common-name");
            const subcat = target.getAttribute("data-subcat") || null;
            basePrintItems(contract, commonName, subcat);
        }
    });

    refreshTableData();
    setInterval(refreshTableData, 60000);
});
</script>
</body>
</html>