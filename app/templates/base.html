<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RFID Inventory Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .nav-tabs {
            background: #2c3e50; /* Dark slate */
            border-bottom: 3px solid #e74c3c; /* Red accent */
        }
        .nav-link {
            color: #ecf0f1; /* Light gray */
            font-weight: bold;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: #e74c3c; /* Red hover */
            background: #34495e; /* Slightly lighter slate */
        }
        .nav-link.active {
            color: #fff;
            background: #e74c3c; /* Active red */
            border: none;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.7); /* Glow */
        }
        body {
            background: #ecf0f1; /* Light gray bg */
            font-family: 'Arial', sans-serif;
        }
        .container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <header class="mb-4">
        <nav>
            <ul class="nav nav-tabs">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab1/">Active Rentals</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab2/">Categories</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab3/">Service Items</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab4/">Full Inventory</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab5/">Laundry Contracts</a></li>
                <li class="nav-item"><a class="nav-link" href="/tab6/">Resale Items</a></li>
            </ul>
        </nav>
        <div class="mt-2">
            <form action="/manual_refresh" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-primary">Refresh Data</button>
            </form>
            <form action="/manual_refresh_dev" method="POST" style="display: inline; margin-left: 10px;">
                <button type="submit" class="btn btn-secondary">Refresh Test App</button>
            </form>
        </div>
    </header>
    {% block content %}{% endblock %}
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9252bd20fe070709',t:'MTc0Mjc4MzM0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();

document.addEventListener("DOMContentLoaded", function() {
    console.log("Base DOM Content Loaded");

    function refreshTableData() {
        const currentPath = window.location.pathname;
        const urlParams = new URLSearchParams(window.location.search);
        const refreshUrl = `${currentPath.endsWith('/') ? currentPath : currentPath + '/'}refresh_data?${urlParams.toString()}`;

        fetch(refreshUrl)
            .then(response => {
                console.log(`Refresh Fetch Status: ${response.status}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("Refresh Data:", data);
                const parentTbody = document.querySelector("#parentTable tbody");
                if (parentTbody && data.parent_data) {
                    const expandedMiddle = new Set();
                    const expandedChild = new Set();
                    document.querySelectorAll(".collapse.show").forEach(el => {
                        if (el.id.startsWith("middle-")) expandedMiddle.add(el.id);
                        if (el.id.startsWith("child-")) expandedChild.add(el.id);
                    });

                    parentTbody.innerHTML = "";
                    data.parent_data.forEach((parent, parentIndex) => {
                        const parentIdx = parentIndex + (data.current_page ? data.current_page - 1 : 0) * 20;
                        const key = (parent.contract_num || parent.category || 'unknown').toLowerCase().replace(/[^a-z0-9_]/g, '');
                        const tr = document.createElement("tr");
                        tr.className = "table-active";
                        tr.style.background = "linear-gradient(to right, #ecf0f1, #dfe6e9)";
                        tr.innerHTML = `
                            <td style="width: 50px;"><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-${key}">+</span></td>
                            <td>${parent.contract_num || parent.category || 'Unknown'}</td>
                            <td>${parent.client_name || parent.total_amount || 'N/A'}</td>
                            <td>${parent.total_items || parent.total || 0}</td>
                            <td>${parent.scan_date || parent.date_last_scanned || 'N/A'}</td>
                            <td>${parent.transaction_notes || 'N/A'}</td>
                            <td style="width: 100px;"><button class="btn btn-outline-dark btn-sm tabPrintBtn" 
                                data-contract="${parent.contract_num || parent.category || 'unknown'}" 
                                style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
                        `;
                        parentTbody.appendChild(tr);

                        const middleTr = document.createElement("tr");
                        middleTr.innerHTML = `
                            <td colspan="7" class="p-0">
                                <div id="middle-${key}" class="collapse" 
                                    data-contract="${parent.contract_num || parent.category || 'unknown'}">
                                    <table class="table table-striped table-bordered middle-table" 
                                        style="border: 2px solid #34495e;">
                                        <thead style="background: #3498db; color: #fff;">
                                            <tr>
                                                <th style="width: 50px;"></th>
                                                <th>Common Name</th>
                                                <th>Total on Contract</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </td>
                        `;
                        parentTbody.appendChild(middleTr);

                        const middleTbody = document.querySelector(`#middle-${key} tbody`);
                        if (middleTbody && data.middle_map && data.middle_map[parent.contract_num || parent.category]) {
                            data.middle_map[parent.contract_num || parent.category].forEach((middle, middleIndex) => {
                                const middleIdx = `${key}_${middleIndex}`;
                                const middleRow = document.createElement("tr");
                                middleRow.innerHTML = `
                                    <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-${middleIdx}">+</span></td>
                                    <td>${middle.common_name}</td>
                                    <td>${middle.total_on_contract || middle.total || 0}</td>
                                `;
                                middleTbody.appendChild(middleRow);

                                const childTr = document.createElement("tr");
                                childTr.innerHTML = `
                                    <td colspan="3" class="p-0">
                                        <div id="child-${middleIdx}" class="collapse">
                                            <table class="table table-striped table-bordered child-table" 
                                                style="border: 2px solid #2c3e50;">
                                                <thead style="background: #2c3e50; color: #ecf0f1;">
                                                    <tr>
                                                        <th>Tag ID</th>
                                                        <th>Common Name</th>
                                                        <th>Quality</th>
                                                        <th>Bin Location</th>
                                                        <th>Status</th>
                                                        <th>Last Scanned By</th>
                                                        <th>Date Last Scanned</th>
                                                        <th>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </td>
                                `;
                                middleTbody.appendChild(childTr);

                                const childTbody = document.querySelector(`#child-${middleIdx} tbody`);
                                if (childTbody && data.contract_map && data.contract_map[parent.contract_num || parent.category] && data.contract_map[parent.contract_num || parent.category][middle.common_name]) {
                                    data.contract_map[parent.contract_num || parent.category][middle.common_name].forEach(item => {
                                        const childRow = document.createElement("tr");
                                        childRow.className = item.status in ['On Rent', 'Delivered'] ? 'table-warning' : item.status === 'Ready to Rent' ? 'table-success' : '';
                                        childRow.innerHTML = `
                                            <td>${item.tag_id || 'N/A'}</td>
                                            <td>${item.common_name}</td>
                                            <td>${item.quality || 'N/A'}</td>
                                            <td>${item.bin_location || 'N/A'}</td>
                                            <td>${item.status || 'N/A'}</td>
                                            <td>${item.last_scanned_by || 'Unknown'}</td>
                                            <td>${item.date_last_scanned || 'N/A'}</td>
                                            <td>${item.notes || 'N/A'}</td>
                                        `;
                                        childTbody.appendChild(childRow);
                                    });
                                }

                                if (expandedChild.has(`child-${middleIdx}`)) {
                                    new bootstrap.Collapse(document.getElementById(`child-${middleIdx}`), { toggle: false }).show();
                                }
                            });
                        }

                        if (expandedMiddle.has(`middle-${key}`)) {
                            new bootstrap.Collapse(document.getElementById(`middle-${key}`), { toggle: false }).show();
                        }
                    });
                }
            })
            .catch(error => console.error("Refresh Error:", error));
    }

    // Bind expand toggle listeners
    document.querySelectorAll(".expand-toggle").forEach(toggle => {
        toggle.addEventListener("click", () => {
            const targetId = toggle.getAttribute("data-bs-target");
            const target = document.querySelector(targetId);
            if (target && !target.classList.contains("show")) {
                toggle.textContent = "-";
            } else if (target) {
                toggle.textContent = "+";
            }
        });
    });

    // Initial load and refresh every 60 seconds
    refreshTableData();
    setInterval(refreshTableData, 60000);
});
</script>
</body>
</html>