{% extends "base.html" %}
{% block content %}

<h1 style="color: #2c3e50; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">Active Rentals</h1>

<div class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="table-filter form-control" data-filter="contract_num" placeholder="Filter Contract Number" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="table-filter form-control" data-filter="common_name" placeholder="Filter Common Name" />
  </div>
</div>

<nav aria-label="Page navigation" class="mb-3">
  <ul class="pagination justify-content-center flex-wrap">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page-1) }}" aria-label="Previous">
        <span aria-hidden="true">« Prev</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page+1) }}" aria-label="Next">
        <span aria-hidden="true">Next »</span>
      </a>
    </li>
  </ul>
</nav>

<div class="table-responsive">
  <table class="table table-striped table-bordered" id="parentTable" style="border: 3px solid #2c3e50;">
    <thead style="background: #34495e; color: #ecf0f1;">
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="contract_num">Contract #</th>
        <th class="sortable" data-col-name="client_name">Client Name</th>
        <th class="sortable" data-col-name="total_items">Total Items</th>
        <th class="sortable" data-col-name="scan_date">Last Scan Date</th>
        <th class="sortable" data-col-name="transaction_notes">Transaction Notes</th>
        <th style="width: 100px;">Print</th>
      </tr>
    </thead>
    <tbody>
      {% for parent in parent_data %}
      {% set parent_idx = loop.index + (current_page - 1) * 20 %}
      <tr class="table-active" style="background: linear-gradient(to right, #ecf0f1, #dfe6e9);">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-{{ parent_idx }}">+</span></td>
        <td>{{ parent.contract_num }}</td>
        <td>{{ parent.client_name }}</td>
        <td>{{ parent.total_items }}</td>
        <td>{{ parent.scan_date }}</td>
        <td>{{ parent.transaction_notes }}</td>
        <td><button class="btn btn-outline-dark btn-sm aggregateTab1-btn" data-contract="{{ parent.contract_num }}" style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
      </tr>
      <tr>
        <td colspan="7" class="p-0">
          <div id="middle-{{ parent_idx }}" class="collapse">
            <table class="table mb-0 middle-table" id="middleTable-{{ parent_idx }}" style="border: 2px solid #34495e;">
              <thead style="background: #3498db; color: #fff;">
                <tr>
                  <th style="width: 50px;"></th>
                  <th class="sortable" data-col-name="common_name">Common Name</th>
                  <th class="sortable" data-col-name="total_on_contract">Total on Contract</th>
                </tr>
              </thead>
              <tbody>
                {% for middle in middle_data[parent.contract_num] %}
                {% set middle_idx = parent_idx ~ '_' ~ loop.index %}
                <tr>
                  <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-{{ middle_idx }}">+</span></td>
                  <td>{{ middle.common_name }}</td>
                  <td>{{ middle.total_on_contract }}</td>
                </tr>
                <tr>
                  <td colspan="3" class="p-0">
                    <div id="child-{{ middle_idx }}" class="collapse">
                      <table class="table mb-0 child-table" id="childTable-{{ middle_idx }}" style="border: 2px solid #2c3e50;">
                        <thead style="background: #2c3e50; color: #ecf0f1;">
                          <tr>
                            <th class="sortable" data-col-name="tag_id">Tag ID</th>
                            <th class="sortable" data-col-name="common_name">Common Name</th>
                            <th class="sortable" data-col-name="quality">Quality</th>
                            <th class="sortable" data-col-name="bin_location">Bin Location</th>
                            <th class="sortable" data-col-name="status">Status</th>
                            <th class="sortable" data-col-name="last_scanned_by">Last Scanned By</th>
                            <th class="sortable" data-col-name="date_last_scanned">Date Last Scanned</th>
                            <th class="sortable" data-col-name="notes">Notes</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in contract_map[parent.contract_num][middle.common_name] %}
                          <tr class="{% if item.status in ['On Rent', 'Delivered'] %}table-warning{% elif item.status == 'Ready to Rent' %}table-success{% endif %}">
                            <td>{{ item.tag_id }}</td>
                            <td>{{ item.common_name }}</td>
                            <td>{{ item.quality }}</td>
                            <td>{{ item.bin_location }}</td>
                            <td>{{ item.status }}</td>
                            <td>{{ item.last_scanned_by }}</td>
                            <td>{{ item.date_last_scanned }}</td>
                            <td>{{ item.notes }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Page navigation" class="mt-3">
  <ul class="pagination justify-content-center flex-wrap">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page-1) }}" aria-label="Previous">
        <span aria-hidden="true">« Prev</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page+1) }}" aria-label="Next">
        <span aria-hidden="true">Next »</span>
      </a>
    </li>
  </ul>
</nav>

<script>
function sortTable(tableEl, colName) {
  let tbody = tableEl.querySelector("tbody");
  if (!tbody) return;

  let asc = tableEl.getAttribute("data-sort-col") === colName 
            ? tableEl.getAttribute("data-sort-dir") !== "asc" 
            : true;
  tableEl.setAttribute("data-sort-col", colName);
  tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

  let headers = Array.from(tableEl.querySelectorAll("th"));
  let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

  if (tableEl.id === "parentTable") {
    let rows = Array.from(tbody.children);
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let parentRow = rows[i];
      let middleRow = rows[i + 1] || null;
      if (parentRow && parentRow.classList.contains("table-active")) {
        pairs.push({ parent: parentRow, middle: middleRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.parent);
      if (pair.middle) tbody.appendChild(pair.middle);
    });
  } else if (tableEl.classList.contains("middle-table")) {
    let rows = Array.from(tbody.children);
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let middleRow = rows[i];
      let childRow = rows[i + 1] || null;
      if (middleRow) {
        pairs.push({ middle: middleRow, child: childRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.middle.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.middle.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.middle);
      if (pair.child) tbody.appendChild(pair.child);
    });
  } else {
    let rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      let cellA = a.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }
}

function filterTable() {
  let filters = {
    contract_num: document.querySelector("[data-filter='contract_num']").value.toLowerCase().trim(),
    common_name: document.querySelector("[data-filter='common_name']").value.toLowerCase().trim()
  };

  let parentRows = document.querySelectorAll("#parentTable tbody tr.table-active");
  parentRows.forEach(parentRow => {
    let middleRow = parentRow.nextElementSibling;
    let middleTable = middleRow.querySelector(".middle-table tbody");
    let middleItems = middleTable.querySelectorAll("tr:not(.collapse)");
    let anyMiddleMatch = false;

    middleItems.forEach(middle => {
      let childRow = middle.nextElementSibling;
      let childTable = childRow.querySelector(".child-table tbody");
      let childItems = childTable.querySelectorAll("tr");
      let anyChildMatch = false;

      childItems.forEach(item => {
        let contractNum = parentRow.cells[1].innerText.toLowerCase();
        let commonName = item.cells[1].innerText.toLowerCase();

        let matches = (!filters.contract_num || contractNum.includes(filters.contract_num)) &&
                      (!filters.common_name || commonName.includes(filters.common_name));

        item.style.display = matches ? "" : "none";
        if (matches) anyChildMatch = true;
      });

      middle.style.display = anyChildMatch ? "" : "none";
      childRow.style.display = anyChildMatch ? "" : "none";
      if (anyChildMatch) anyMiddleMatch = true;
    });

    parentRow.style.display = anyMiddleMatch ? "" : "none";
    middleRow.style.display = anyMiddleMatch ? "" : "none";
  });
}

function tab1RefreshTableData() {
  const path = window.location.pathname;
  const params = new URLSearchParams(window.location.search);
  const url = path.endsWith('/') ? path : path + '/' + 'refresh_data?' + params.toString();

  fetch(url)
    .then(response => {
      console.log('Tab1 Refresh Fetch Status: ' + response.status);
      if (!response.ok) throw new Error('HTTP error! Status: ' + response.status);
      return response.json();
    })
    .then(data => {
      console.log('Tab1 Refresh Data:', data);
      const tbody = document.querySelector('#parentTable tbody');
      if (tbody) {
        const expandedMiddle = new Set();
        const expandedChild = new Set();
        document.querySelectorAll('.collapse.show').forEach(el => {
          if (el.id.startsWith('middle-')) expandedMiddle.add(el.id);
          if (el.id.startsWith('child-')) expandedChild.add(el.id);
        });

        tbody.innerHTML = '';
        data.parent_data.forEach((parent, parentIndex) => {
          const parentIdx = parentIndex + (data.current_page - 1) * 20;
          const parentRow = document.createElement('tr');
          parentRow.className = 'table-active';
          parentRow.style.background = 'linear-gradient(to right, #ecf0f1, #dfe6e9)';

          const toggleTd = document.createElement('td');
          const toggleSpan = document.createElement('span');
          toggleSpan.className = 'expand-toggle';
          toggleSpan.setAttribute('data-bs-toggle', 'collapse');
          toggleSpan.setAttribute('data-bs-target', '#middle-' + parentIdx);
          toggleSpan.textContent = '+';
          toggleTd.appendChild(toggleSpan);
          parentRow.appendChild(toggleTd);

          const fields = ['contract_num', 'client_name', 'total_items', 'scan_date', 'transaction_notes'];
          fields.forEach(field => {
            const td = document.createElement('td');
            td.textContent = parent[field];
            parentRow.appendChild(td);
          });

          const printTd = document.createElement('td');
          const printBtn = document.createElement('button');
          printBtn.className = 'btn btn-outline-dark btn-sm aggregateTab1-btn';
          printBtn.setAttribute('data-contract', parent.contract_num);
          printBtn.style.border = '2px solid #2c3e50';
          printBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          printBtn.style.transition = 'all 0.3s';
          printBtn.textContent = 'Print';
          printTd.appendChild(printBtn);
          parentRow.appendChild(printTd);

          tbody.appendChild(parentRow);

          const middleRow = document.createElement('tr');
          const middleTd = document.createElement('td');
          middleTd.setAttribute('colspan', '7');
          middleTd.className = 'p-0';

          const middleDiv = document.createElement('div');
          middleDiv.id = 'middle-' + parentIdx;
          middleDiv.className = 'collapse';

          const middleTable = document.createElement('table');
          middleTable.className = 'table mb-0 middle-table';
          middleTable.id = 'middleTable-' + parentIdx;
          middleTable.style.border = '2px solid #34495e';

          const thead = document.createElement('thead');
          thead.style.background = '#3498db';
          thead.style.color = '#fff';
          const headerRow = document.createElement('tr');
          const headers = [
            { name: '', width: '50px' },
            { name: 'Common Name', col: 'common_name' },
            { name: 'Total on Contract', col: 'total_on_contract' }
          ];
          headers.forEach(h => {
            const th = document.createElement('th');
            if (h.col) th.className = 'sortable';
            if (h.col) th.setAttribute('data-col-name', h.col);
            if (h.width) th.style.width = h.width;
            th.textContent = h.name;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          middleTable.appendChild(thead);

          const middleTbody = document.createElement('tbody');
          if (data.middle_map[parent.contract_num]) {
            data.middle_map[parent.contract_num].forEach((middle, middleIndex) => {
              const middleIdx = parentIdx + '_' + middleIndex;
              const tr = document.createElement('tr');

              const toggleTdMiddle = document.createElement('td');
              const toggleSpanMiddle = document.createElement('span');
              toggleSpanMiddle.className = 'expand-toggle';
              toggleSpanMiddle.setAttribute('data-bs-toggle', 'collapse');
              toggleSpanMiddle.setAttribute('data-bs-target', '#child-' + middleIdx);
              toggleSpanMiddle.textContent = '+';
              toggleTdMiddle.appendChild(toggleSpanMiddle);
              tr.appendChild(toggleTdMiddle);

              const nameTd = document.createElement('td');
              nameTd.textContent = middle.common_name;
              const totalTd = document.createElement('td');
              totalTd.textContent = middle.total_on_contract;
              tr.appendChild(nameTd);
              tr.appendChild(totalTd);
              middleTbody.appendChild(tr);

              const childRow = document.createElement('tr');
              const childTd = document.createElement('td');
              childTd.setAttribute('colspan', '3');
              childTd.className = 'p-0';

              const childDiv = document.createElement('div');
              childDiv.id = 'child-' + middleIdx;
              childDiv.className = 'collapse';

              const childTable = document.createElement('table');
              childTable.className = 'table mb-0 child-table';
              childTable.id = 'childTable-' + middleIdx;
              childTable.style.border = '2px solid #2c3e50';

              const childThead = document.createElement('thead');
              childThead.style.background = '#2c3e50';
              childThead.style.color = '#ecf0f1';
              const childHeaderRow = document.createElement('tr');
              const childHeaders = [
                'tag_id', 'common_name', 'quality', 'bin_location', 'status', 
                'last_scanned_by', 'date_last_scanned', 'notes'
              ].map(col => ({ name: col.replace('_', ' ').toUpperCase(), col }));
              childHeaders.forEach(h => {
                const th = document.createElement('th');
                th.className = 'sortable';
                th.setAttribute('data-col-name', h.col);
                th.textContent = h.name;
                childHeaderRow.appendChild(th);
              });
              childThead.appendChild(childHeaderRow);
              childTable.appendChild(childThead);

              const childTbody = document.createElement('tbody');
              if (data.contract_map[parent.contract_num] && data.contract_map[parent.contract_num][middle.common_name]) {
                data.contract_map[parent.contract_num][middle.common_name].forEach(item => {
                  const tr = document.createElement('tr');
                  tr.className = item.status in ['On Rent', 'Delivered'] ? 'table-warning' : item.status === 'Ready to Rent' ? 'table-success' : '';
                  childHeaders.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = item[h.col] || '';
                    tr.appendChild(td);
                  });
                  childTbody.appendChild(tr);
                });
              }
              childTable.appendChild(childTbody);

              childDiv.appendChild(childTable);
              childTd.appendChild(childDiv);
              childRow.appendChild(childTd);
              middleTbody.appendChild(childRow);

              if (expandedChild.has('child-' + middleIdx)) {
                new bootstrap.Collapse(childDiv, { toggle: false }).show();
              }
            });
          }
          middleTable.appendChild(middleTbody);
          middleDiv.appendChild(middleTable);
          middleTd.appendChild(middleDiv);
          middleRow.appendChild(middleTd);
          tbody.appendChild(middleRow);

          if (expandedMiddle.has('middle-' + parentIdx)) {
            new bootstrap.Collapse(middleDiv, { toggle: false }).show();
          }
        });

        bindTab1Listeners();
        filterTable();
      }
    })
    .catch(error => console.error('Tab1 Refresh Error:', error));
}

document.addEventListener("DOMContentLoaded", () => {
  let parentTable = document.getElementById("parentTable");
  parentTable.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      let colName = th.getAttribute("data-col-name");
      sortTable(parentTable, colName);
    });
  });

  document.querySelectorAll(".middle-table").forEach(middleTbl => {
    middleTbl.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        let colName = th.getAttribute("data-col-name");
        sortTable(middleTbl, colName);
      });
    });
  });

  document.querySelectorAll(".child-table").forEach(childTbl => {
    childTbl.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        let colName = th.getAttribute("data-col-name");
        sortTable(childTbl, colName);
      });
    });
  });

  document.querySelectorAll(".table-filter").forEach(input => {
    input.addEventListener("input", filterTable);
  });

  document.querySelectorAll(".expand-toggle").forEach(toggle => {
    let target = document.querySelector(toggle.getAttribute("data-bs-target"));
    target.addEventListener("show.bs.collapse", () => {
      toggle.textContent = "-";
    });
    target.addEventListener("hide.bs.collapse", () => {
      toggle.textContent = "+";
    });
  });

  // No print logic—placeholders only

  document.querySelectorAll(".btn").forEach(btn => {
    btn.addEventListener("mouseover", () => {
      btn.style.transform = "translateY(-2px)";
      btn.style.boxShadow = "0 4px 8px rgba(0,0,0,0.3)";
    });
    btn.addEventListener("mouseout", () => {
      btn.style.transform = "translateY(0)";
      btn.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
    });
  });

  filterTable();
  window.tab1RefreshTableData = tab1RefreshTableData;
  tab1RefreshTableData();
  setInterval(tab1RefreshTableData, 60000);
});
</script>

<style>
  .table-warning { background: #ffff99; }
  .table-success { background: #ccffcc; }
  @media (max-width: 768px) {
    .table-filter { font-size: 0.9rem; }
    .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.9rem; }
  }
</style>

{% endblock %}