{% extends "base.html" %}
{% block content %}

<h1 style="color: #2c3e50; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">Active Rentals</h1>

<form method="GET" class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="contract_num" placeholder="Filter Contract" value="{{ filter_contract_num }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="client_name" placeholder="Filter Client" value="{{ filter_client_name }}" />
  </div>
  <div class="col-12 col-md-2">
    <button type="submit" class="btn btn-primary" style="background: #e74c3c; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Apply Filters</button>
  </div>
</form>

<div class="table-container">
  <table class="table table-striped table-bordered" id="parentTable" style="border: 3px solid #2c3e50;">
    <thead style="background: #34495e; color: #ecf0f1;">
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="contract_num">Contract Number</th>
        <th class="sortable" data-col-name="client_name">Client Name</th>
        <th class="sortable" data-col-name="total_items">Total Items</th>
        <th class="sortable" data-col-name="scan_date">Last Scan Date</th>
        <th class="sortable" data-col-name="transaction_notes">Transaction Notes</th>
        <th style="width: 100px;">Print</th>
      </tr>
    </thead>
    <tbody>
      {% for parent in parent_data %}
      {% set contract_key = parent.contract_num|lower|replace(' ', '_') %}
      <tr class="table-active" style="background: linear-gradient(to right, #ecf0f1, #dfe6e9);">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-{{ contract_key }}">+</span></td>
        <td>{{ parent.contract_num }}</td>
        <td>{{ parent.client_name }}</td>
        <td>{{ parent.total_items }}</td>
        <td>{{ parent.scan_date }}</td>
        <td>{{ parent.transaction_notes }}</td>
        <td><button class="btn btn-outline-dark btn-sm tab1-print-btn" data-contract="{{ parent.contract_num }}" style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
      </tr>
      <tr>
        <td colspan="7" class="p-0">
          <div id="middle-{{ contract_key }}" class="collapse" data-contract="{{ parent.contract_num }}">
            <div class="child-table-container">
              <table class="table table-striped table-bordered middle-table" id="middleTable-{{ contract_key }}" style="border: 2px solid #34495e;">
                <thead style="background: #3498db; color: #fff;">
                  <tr>
                    <th class="sortable" data-col-name="common_name">Common Name</th>
                    <th class="sortable" data-col-name="total_on_contract">Total on Contract</th>
                  </tr>
                </thead>
                <tbody>
                  {% for middle in middle_data[parent.contract_num] %}
                  <tr>
                    <td>{{ middle.common_name }}</td>
                    <td>{{ middle.total_on_contract }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination -->
  <nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page-1, contract_num=filter_contract_num, client_name=filter_client_name) }}" aria-label="Previous">
          <span aria-hidden="true">«</span>
        </a>
      </li>
      {% for page_num in range(1, total_pages + 1) %}
      <li class="page-item {% if page_num == current_page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=page_num, contract_num=filter_contract_num, client_name=filter_client_name) }}">{{ page_num }}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page+1, contract_num=filter_contract_num, client_name=filter_client_name) }}" aria-label="Next">
          <span aria-hidden="true">»</span>
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- Override base.html scripts -->
<script>
// Block base.html's refreshTableData from running initially
document.addEventListener("DOMContentLoaded", () => {
    console.log("Tab1 DOM Content Loaded - Overriding Base");

    // Prevent base.html's refreshTableData from firing
    window.refreshTableData = function() {
        console.log("Base refreshTableData blocked for Tab1");
    };

    function sortTable(tableEl, colName) {
        console.log(`Sorting ${tableEl.id} by ${colName}`);
        let tbody = tableEl.querySelector("tbody");
        if (!tbody) return;

        let asc = tableEl.getAttribute("data-sort-col") === colName 
                  ? tableEl.getAttribute("data-sort-dir") !== "asc" 
                  : true;
        tableEl.setAttribute("data-sort-col", colName);
        tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

        let headers = Array.from(tableEl.querySelectorAll("th"));
        let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

        if (tableEl.id === "parentTable") {
            let rows = Array.from(tbody.children);
            let pairs = [];
            for (let i = 0; i < rows.length; i += 2) {
                let parentRow = rows[i];
                let childRow = rows[i + 1] || null;
                if (parentRow && parentRow.classList.contains("table-active")) {
                    pairs.push({ parent: parentRow, child: childRow });
                }
            }
            pairs.sort((a, b) => {
                let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
                let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
                let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
                let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
                if (!isNaN(numA) && !isNaN(numB)) {
                    return asc ? numA - numB : numB - numA;
                }
                return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });
            tbody.innerHTML = "";
            pairs.forEach(pair => {
                tbody.appendChild(pair.parent);
                if (pair.child) tbody.appendChild(pair.child);
            });
        } else {
            let rows = Array.from(tbody.querySelectorAll("tr"));
            rows.sort((a, b) => {
                let cellA = a.cells[colIndex]?.innerText.trim() || "";
                let cellB = b.cells[colIndex]?.innerText.trim() || "";
                let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
                let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
                if (!isNaN(numA) && !isNaN(numB)) {
                    return asc ? numA - numB : numB - numA;
                }
                return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });
            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
        }
    }

    document.querySelectorAll(".sortable").forEach(th => {
        th.addEventListener("click", () => {
            console.log(`Sorting table by ${th.getAttribute("data-col-name")}`);
            const table = th.closest("table");
            const colName = th.getAttribute("data-col-name");
            sortTable(table, colName);
        });
    });

    function tab1RefreshTableData() {
        const currentPath = window.location.pathname;
        const urlParams = new URLSearchParams(window.location.search);
        const refreshUrl = `${currentPath.endsWith('/') ? currentPath : currentPath + '/'}refresh_data?${urlParams.toString()}`;

        fetch(refreshUrl)
            .then(response => {
                console.log(`Tab1 Refresh Fetch Status: ${response.status}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("Tab1 Refresh Data:", data);
                const parentTbody = document.querySelector("#parentTable tbody");
                if (parentTbody) {
                    const expandedMiddle = new Set();
                    document.querySelectorAll(".collapse.show").forEach(el => {
                        if (el.id.startsWith("middle-")) expandedMiddle.add(el.id);
                    });

                    parentTbody.innerHTML = "";
                    data.parent_data.forEach(parent => {
                        const contract_key = parent.contract_num.toLowerCase().replace(/\s+/g, "_");
                        const middleRows = data.middle_map[parent.contract_num]
                            ? data.middle_map[parent.contract_num].map(middle => `
                                <tr>
                                    <td>${middle.common_name}</td>
                                    <td>${middle.total_on_contract}</td>
                                </tr>
                            `).join("")
                            : "";
                        parentTbody.innerHTML += `
                            <tr class="table-active" style="background: linear-gradient(to right, #ecf0f1, #dfe6e9);">
                                <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-${contract_key}">+</span></td>
                                <td>${parent.contract_num}</td>
                                <td>${parent.client_name}</td>
                                <td>${parent.total_items}</td>
                                <td>${parent.scan_date}</td>
                                <td>${parent.transaction_notes}</td>
                                <td><button class="btn btn-outline-dark btn-sm tab1-print-btn" data-contract="${parent.contract_num}" style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
                            </tr>
                            <tr>
                                <td colspan="7" class="p-0">
                                    <div id="middle-${contract_key}" class="collapse" data-contract="${parent.contract_num}">
                                        <div class="child-table-container">
                                            <table class="table table-striped table-bordered middle-table" id="middleTable-${contract_key}" style="border: 2px solid #34495e;">
                                                <thead style="background: #3498db; color: #fff;">
                                                    <tr>
                                                        <th class="sortable" data-col-name="common_name">Common Name</th>
                                                        <th class="sortable" data-col-name="total_on_contract">Total on Contract</th>
                                                    </tr>
                                                </thead>
                                                <tbody>${middleRows}</tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                        if (expandedMiddle.has(`middle-${contract_key}`)) {
                            const collapse = new bootstrap.Collapse(document.getElementById(`middle-${contract_key}`), { toggle: false });
                            collapse.show();
                        }
                    });

                    // Rebind event listeners
                    document.querySelectorAll(".sortable").forEach(th => {
                        th.addEventListener("click", () => {
                            console.log(`Sorting table by ${th.getAttribute("data-col-name")}`);
                            const table = th.closest("table");
                            const colName = th.getAttribute("data-col-name");
                            sortTable(table, colName);
                        });
                    });

                    document.querySelectorAll(".expand-toggle").forEach(toggle => {
                        toggle.addEventListener("click", () => {
                            const targetId = toggle.getAttribute("data-bs-target");
                            console.log(`Toggle clicked: ${targetId}`);
                            const target = document.querySelector(targetId);
                            if (target && !target.classList.contains('show')) {
                                toggle.textContent = "-";
                            } else if (target) {
                                toggle.textContent = "+";
                            }
                        });
                    });

                    document.querySelectorAll(".tab1-print-btn").forEach(btn => {
                        btn.addEventListener("click", (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const contract = btn.getAttribute("data-contract");
                            console.log(`Tab1 Printing contract: ${contract}`);
                            const parentRow = Array.from(document.querySelectorAll("#parentTable tr.table-active"))
                                .find(row => row.querySelector("td:nth-child(2)").innerText === contract);
                            const middleTbody = document.querySelector(`#middleTable-${contract.toLowerCase().replace(/\s+/g, "_")} tbody`);
                            const middleRows = middleTbody ? Array.from(middleTbody.querySelectorAll("tr")).map(row => `
                                <tr>
                                    <td>${row.cells[0].innerText}</td>
                                    <td>${row.cells[1].innerText}</td>
                                </tr>
                            `).join("") : "<tr><td colspan='2'>No items</td></tr>";
                            const printWin = window.open("", "_blank");
                            printWin.document.write(`
                                <html>
                                <head>
                                    <title>Active Rental Contract ${contract}</title>
                                    <style>
                                        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                                        h1 { font-size: 1.5em; text-align: center; color: #2c3e50; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
                                        table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                                        th, td { border: 2px solid #34495e; padding: 8px; text-align: left; }
                                        th { background: #3498db; color: #fff; font-weight: bold; }
                                        tr:nth-child(even) { background: #f9f9f9; }
                                        tr:hover { background: #dfe6e9; }
                                    </style>
                                </head>
                                <body>
                                    <h1>Active Rental Contract ${contract}</h1>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Contract Number</th>
                                                <th>Client Name</th>
                                                <th>Total Items</th>
                                                <th>Last Scan Date</th>
                                                <th>Transaction Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>${parentRow.cells[1].innerText}</td>
                                                <td>${parentRow.cells[2].innerText}</td>
                                                <td>${parentRow.cells[3].innerText}</td>
                                                <td>${parentRow.cells[4].innerText}</td>
                                                <td>${parentRow.cells[5].innerText}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <h2>Items</h2>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Common Name</th>
                                                <th>Total on Contract</th>
                                            </tr>
                                        </thead>
                                        <tbody>${middleRows}</tbody>
                                    </table>
                                    <script>window.print(); window.close();</script>
                                </body>
                                </html>
                            `);
                            printWin.document.close();
                        });
                    });
                }
            })
            .catch(error => console.error("Tab1 Refresh Error:", error));
    }

    // Initial load and refresh every 60 seconds
    tab1RefreshTableData();
    setInterval(tab1RefreshTableData, 60000);

    // Stop base.html's interval
    clearInterval(window.setInterval); // Crude, but stops base.html's 60s refresh
});
</script>

<style>
  .table-danger { background: #ffcccc; }
  .table-warning { background: #ffff99; }
  .table-success { background: #ccffcc; }
  body, html {
    height: 100%;
    overflow-y: auto;
    margin: 0;
    padding: 0;
  }
  .table-container {
    width: 100%;
    overflow-y: visible;
    padding-bottom: 100px;
  }
  .table-container table {
    width: 100%;
    table-layout: auto;
  }
  .child-table-container {
    width: 100%;
    overflow-y: visible;
  }
  .child-table-container table {
    width: 100%;
    table-layout: auto;
  }
  .collapse {
    width: 100%;
  }
  .pagination .page-link {
    color: #2c3e50;
    border: 2px solid #34495e;
    transition: all 0.3s;
  }
  .pagination .page-item.active .page-link {
    background: #e74c3c;
    border-color: #e74c3c;
    color: #fff;
  }
  .pagination .page-link:hover {
    background: #34495e;
    color: #ecf0f1;
    border-color: #34495e;
  }
</style>

{% endblock %}