{% extends "base.html" %}
{% block content %}

<h1 style="color: #2c3e50; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">Active Rentals</h1>

<form method="GET" class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="contract_num" placeholder="Filter Contract" value="{{ filter_contract_num }}">
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="client_name" placeholder="Filter Client" value="{{ filter_client_name }}">
  </div>
  <div class="col-12 col-md-2">
    <button type="submit" class="btn btn-primary" style="background: #e74c3c; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Apply Filters</button>
  </div>
</form>

<div class="table-container">
  <table class="table table-striped table-bordered" id="parentTable" style="border: 3px solid #2c3e50;">
    <thead style="background: #34495e; color: #ecf0f1;">
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="contract_num">Contract Number</th>
        <th class="sortable" data-col-name="client_name">Client Name</th>
        <th class="sortable" data-col-name="total_items">Total Items</th>
        <th class="sortable" data-col-name="scan_date">Last Scan Date</th>
        <th class="sortable" data-col-name="transaction_notes">Transaction Notes</th>
        <th style="width: 100px;">Print</th>
      </tr>
    </thead>
    <tbody>
      {% for parent in parent_data %}
      {% set contract_key = parent.contract_num|lower|replace(' ', '_') %}
      <tr class="table-active" style="background: linear-gradient(to right, #ecf0f1, #dfe6e9);">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-{{ contract_key }}">+</span></td>
        <td>{{ parent.contract_num }}</td>
        <td>{{ parent.client_name }}</td>
        <td>{{ parent.total_items }}</td>
        <td>{{ parent.scan_date }}</td>
        <td>{{ parent.transaction_notes }}</td>
        <td><button class="btn btn-outline-dark btn-sm tab1-print-btn" data-contract="{{ parent.contract_num }}" style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
      </tr>
      <tr>
        <td colspan="7" class="p-0">
          <div id="middle-{{ contract_key }}" class="collapse" data-contract="{{ parent.contract_num }}">
            <div class="child-table-container">
              <table class="table table-striped table-bordered middle-table" id="middleTable-{{ contract_key }}" style="border: 2px solid #34495e;">
                <thead style="background: #3498db; color: #fff;">
                  <tr>
                    <th class="sortable" data-col-name="common_name">Common Name</th>
                    <th class="sortable" data-col-name="total_on_contract">Total on Contract</th>
                  </tr>
                </thead>
                <tbody>
                  {% for middle in middle_data[parent.contract_num] %}
                  <tr>
                    <td>{{ middle.common_name }}</td>
                    <td>{{ middle.total_on_contract }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page-1, contract_num=filter_contract_num, client_name=filter_client_name) }}" aria-label="Previous">
          <span aria-hidden="true">«</span>
        </a>
      </li>
      {% for page_num in range(1, total_pages + 1) %}
      <li class="page-item {% if page_num == current_page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=page_num, contract_num=filter_contract_num, client_name=filter_client_name) }}">{{ page_num }}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('tab1_bp.show_tab1', page=current_page+1, contract_num=filter_contract_num, client_name=filter_client_name) }}" aria-label="Next">
          <span aria-hidden="true">»</span>
        </a>
      </li>
    </ul>
  </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tab1 DOM Content Loaded');

    function tab1RefreshTableData() {
        const path = window.location.pathname;
        const params = new URLSearchParams(window.location.search);
        const url = path.endsWith('/') ? path : path + '/' + 'refresh_data?' + params.toString();

        fetch(url)
            .then(response => {
                console.log('Tab1 Refresh Fetch Status: ' + response.status);
                if (!response.ok) throw new Error('HTTP error! Status: ' + response.status);
                return response.json();
            })
            .then(data => {
                console.log('Tab1 Refresh Data:', data);
                const tbody = document.querySelector('#parentTable tbody');
                if (tbody) {
                    const expanded = new Set();
                    document.querySelectorAll('.collapse.show').forEach(el => {
                        if (el.id.startsWith('middle-')) expanded.add(el.id);
                    });

                    tbody.innerHTML = '';
                    data.parent_data.forEach(parent => {
                        const key = parent.contract_num.toLowerCase().replace(/\s+/g, '_');

                        const parentRow = document.createElement('tr');
                        parentRow.className = 'table-active';
                        parentRow.style.background = 'linear-gradient(to right, #ecf0f1, #dfe6e9)';

                        const toggleTd = document.createElement('td');
                        const toggleSpan = document.createElement('span');
                        toggleSpan.className = 'expand-toggle';
                        toggleSpan.setAttribute('data-bs-toggle', 'collapse');
                        toggleSpan.setAttribute('data-bs-target', '#middle-' + key);
                        toggleSpan.textContent = '+';
                        toggleTd.appendChild(toggleSpan);
                        parentRow.appendChild(toggleTd);

                        const fields = ['contract_num', 'client_name', 'total_items', 'scan_date', 'transaction_notes'];
                        fields.forEach(field => {
                            const td = document.createElement('td');
                            td.textContent = parent[field];
                            parentRow.appendChild(td);
                        });

                        const printTd = document.createElement('td');
                        const printBtn = document.createElement('button');
                        printBtn.className = 'btn btn-outline-dark btn-sm tab1-print-btn';
                        printBtn.setAttribute('data-contract', parent.contract_num);
                        printBtn.style.border = '2px solid #2c3e50';
                        printBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                        printBtn.style.transition = 'all 0.3s';
                        printBtn.textContent = 'Print';
                        printTd.appendChild(printBtn);
                        parentRow.appendChild(printTd);

                        tbody.appendChild(parentRow);

                        const childRow = document.createElement('tr');
                        const childTd = document.createElement('td');
                        childTd.setAttribute('colspan', '7');
                        childTd.className = 'p-0';

                        const collapseDiv = document.createElement('div');
                        collapseDiv.id = 'middle-' + key;
                        collapseDiv.className = 'collapse';
                        collapseDiv.setAttribute('data-contract', parent.contract_num);

                        const containerDiv = document.createElement('div');
                        containerDiv.className = 'child-table-container';

                        const middleTable = document.createElement('table');
                        middleTable.className = 'table table-striped table-bordered middle-table';
                        middleTable.id = 'middleTable-' + key;
                        middleTable.style.border = '2px solid #34495e';

                        const thead = document.createElement('thead');
                        thead.style.background = '#3498db';
                        thead.style.color = '#fff';
                        const headerRow = document.createElement('tr');
                        const headers = [
                            { name: 'Common Name', col: 'common_name' },
                            { name: 'Total on Contract', col: 'total_on_contract' }
                        ];
                        headers.forEach(h => {
                            const th = document.createElement('th');
                            th.className = 'sortable';
                            th.setAttribute('data-col-name', h.col);
                            th.textContent = h.name;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        middleTable.appendChild(thead);

                        const middleTbody = document.createElement('tbody');
                        if (data.middle_map[parent.contract_num]) {
                            data.middle_map[parent.contract_num].forEach(middle => {
                                const tr = document.createElement('tr');
                                const nameTd = document.createElement('td');
                                nameTd.textContent = middle.common_name;
                                const totalTd = document.createElement('td');
                                totalTd.textContent = middle.total_on_contract;
                                tr.appendChild(nameTd);
                                tr.appendChild(totalTd);
                                middleTbody.appendChild(tr);
                            });
                        }
                        middleTable.appendChild(middleTbody);

                        containerDiv.appendChild(middleTable);
                        collapseDiv.appendChild(containerDiv);
                        childTd.appendChild(collapseDiv);
                        childRow.appendChild(childTd);
                        tbody.appendChild(childRow);

                        if (expanded.has('middle-' + key)) {
                            new bootstrap.Collapse(collapseDiv, { toggle: false }).show();
                        }
                    });

                    bindTab1Listeners();
                }
            })
            .catch(error => console.error('Tab1 Refresh Error:', error));
    }

    function tab1SortTable(table, colName) {
        console.log('Sorting ' + table.id + ' by ' + colName);
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        const asc = table.getAttribute('data-sort-col') === colName 
            ? table.getAttribute('data-sort-dir') !== 'asc' 
            : true;
        table.setAttribute('data-sort-col', colName);
        table.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');

        const headers = Array.from(table.querySelectorAll('th'));
        const colIndex = headers.findIndex(th => th.getAttribute('data-col-name') === colName);

        if (table.id === 'parentTable') {
            const rows = Array.from(tbody.children);
            const pairs = [];
            for (let i = 0; i < rows.length; i += 2) {
                const parentRow = rows[i];
                const childRow = rows[i + 1] || null;
                if (parentRow && parentRow.classList.contains('table-active')) {
                    pairs.push({ parent: parentRow, child: childRow });
                }
            }
            pairs.sort((a, b) => {
                const cellA = a.parent.cells[colIndex]?.innerText.trim() || '';
                const cellB = b.parent.cells[colIndex]?.innerText.trim() || '';
                const numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ''));
                const numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ''));
                if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
                return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });
            tbody.innerHTML = '';
            pairs.forEach(pair => {
                tbody.appendChild(pair.parent);
                if (pair.child) tbody.appendChild(pair.child);
            });
        } else {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                const cellA = a.cells[colIndex]?.innerText.trim() || '';
                const cellB = b.cells[colIndex]?.innerText.trim() || '';
                const numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ''));
                const numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ''));
                if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
                return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }
    }

    function bindTab1Listeners() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                console.log('Sorting table by ' + th.getAttribute('data-col-name'));
                tab1SortTable(th.closest('table'), th.getAttribute('data-col-name'));
            });
        });

        document.querySelectorAll('.expand-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.getAttribute('data-bs-target');
                console.log('Toggle clicked: ' + targetId);
                const target = document.querySelector(targetId);
                if (target && !target.classList.contains('show')) {
                    toggle.textContent = '-';
                } else if (target) {
                    toggle.textContent = '+';
                }
            });
        });

        document.querySelectorAll('.tab1-print-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                const contract = btn.getAttribute('data-contract');
                console.log('Tab1 Printing contract: ' + contract);
                printItems(contract, ''); // Use base.html's printItems
            });
        });
    }

    bindTab1Listeners();
    window.tab1RefreshTableData = tab1RefreshTableData;
    tab1RefreshTableData();
    setInterval(tab1RefreshTableData, 60000);
});
</script>

<style>
  .table-danger { background: #ffcccc; }
  .table-warning { background: #ffff99; }
  .table-success { background: #ccffcc; }
  body, html {
    height: 100%;
    overflow-y: auto;
    margin: 0;
    padding: 0;
  }
  .table-container {
    width: 100%;
    overflow-y: visible;
    padding-bottom: 100px;
  }
  .table-container table {
    width: 100%;
    table-layout: auto;
  }
  .child-table-container {
    width: 100%;
    overflow-y: visible;
  }
  .child-table-container table {
    width: 100%;
    table-layout: auto;
  }
  .collapse {
    width: 100%;
  }
  .pagination .page-link {
    color: #2c3e50;
    border: 2px solid #34495e;
    transition: all 0.3s;
  }
  .pagination .page-item.active .page-link {
    background: #e74c3c;
    border-color: #e74c3c;
    color: #fff;
  }
  .pagination .page-link:hover {
    background: #34495e;
    color: #ecf0f1;
    border-color: #34495e;
  }
</style>

{% endblock %}